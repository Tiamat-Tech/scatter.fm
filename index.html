<!doctype html>
<html style="height:96%;">
  <head>
    <style>
      #tooltip {
          font-size: 11px;
          font-family: sans-serif;
          position: absolute;
          display: none;
          border: 1px solid #ddf;
          padding 2px;
          opacity: 0.8;
          background-color: #eef;
          padding: 5px;
      }
      #tooltip #text {
        float:right;
        padding: 4px;
      }
      #artist {
        font-weight: bold;
      }
      #date {
        font-weight: bold;
      }
      #tooltip img {
        float:left;
      }
    </style>
  </head>
  <body style="height:100%;">
    <div id="placeholder" style="width:100%;height:100%"></div>
  </body>
  <script src="flot/jquery.js"></script>
  <script src="flot/jquery.flot.js"></script>
  <script src="flot/jquery.flot.navigate.js"></script>
  <script src="flot/jquery.flot.resize.js"></script>
  <script src="date.js"></script>
  <script>

    var colors = [ "red", "green", "blue", "purple", "yellow", "orange", "cyan" ];

    $.getJSON("all_scrobbles.Mark_Hansen.json", function (scrobbles) {
      var artist_scrobbles = {};
      for (var i = 0; i < scrobbles.length; i++) {
        var scrobble = scrobbles[i];
        var artist = scrobble.artist["#text"];
        if (artist_scrobbles[artist]) {
          artist_scrobbles[artist].push(scrobble);
        } else {
          artist_scrobbles[artist] = [ scrobble ];
        }
      }

      var artists = [];

      for (var artist in artist_scrobbles) {
        if (artist_scrobbles.hasOwnProperty(artist)) {
          artists.push(artist_scrobbles[artist]);
        }
      }

      artists.sort(function(a,b) { return b.length - a.length; });

      artist_colors = {};
      for (var i = 0; i < artists.length; i++) {
        var artist = artists[i][0]["artist"]["#text"];
        var color = colors[i] || "gray";
        artist_colors[artist] = color;
      }

      var series = [];

      var minTime = Number.POSITIVE_INFINITY;
      var maxTime = Number.NEGATIVE_INFINITY;
      for (var i = 0; i < scrobbles.length; i++) {
        var scrobble = scrobbles[i];
        var date = new Date(scrobble.date.uts * 1000);
        if (date.getTime() < minTime) minTime = date.getTime();
        if (date.getTime() > maxTime) maxTime = date.getTime();
        var time = date.getHours() + (date.getMinutes() / 60);
        var artist = scrobble.artist["#text"];
        series.push({ 
          color: artist_colors[artist],
          data: [[date.getTime(), time]],
          scrobble: scrobble
        });
      }

      $.plot($("#placeholder"), series, { 
        xaxis: { 
          mode: "time", 
          timeformat: "%d %b %y",
          tickLength: 0,
          zoomRange: [null, maxTime - minTime],
          panRange: [minTime, maxTime]
        },
        yaxis: {
          transform: function (v) { return -v; }, // invert
          inverseTransform: function (v) { return -v; },
          min: 0,
          max: 24,
          tickLength: 0,
          ticks: [0, 3, 6, 9, 12, 15, 18, 21, 24 ],
          tickFormatter: function(val, axis) {
            if (val == 0) return "12am"
            if (val < 12) return val + "am";
            if (val == 12) return "12pm";
            return (val - 12) + "pm";
          },
          zoomRange: false,
          panRange: false
        },
        points: { 
          radius: 0.5,
          show: "true"
        },
        grid: {
          hoverable: true
        },
        zoom: {
          interactive: true
        },
        pan: {
          interactive: true
        }
      });
      var previousPoint = null;
      $("#placeholder").bind("plothover", function (event, pos, item) {
        if (!item) {
          return;
        }
        if (previousPoint == item.seriesIndex) {
          return;
        }
        previousPoint = item.seriesIndex;
        $("#tooltip").remove();
        showTooltip(item.pageX, item.pageY, item.series.scrobble);
      }).bind("mouseout", function () {
        $("#tooltip").remove();
      });
      function showTooltip(x, y, scrobble) {
        var text = "<div id='name'>" + scrobble.name + "</div>";
        text += "<div id='artist'>" + scrobble.artist["#text"] + "</div>";
        text += "<div id='album'>" + scrobble.album["#text"] + "</div>";
        text += "<div id='date'>" + (new Date(scrobble.date.uts * 1000)).toString("HH:mm, ddd dd MMM yyyy") + "</div>";
        var html = "<div id='tooltip'><div id='text'>" + text + "</div></div>";

        $(html).css({
          top: y + 5,
          left: x + 5
        }).appendTo("body").fadeIn(200);

        if (scrobble.image[0] && scrobble.image[0]["#text"]) {
          var img = new Image();
          img.src = scrobble.image[1]["#text"];
          $(img).prependTo("#tooltip");
        }
      }
    });
  </script>
</html>
