<!doctype html>
<html>
  <head>
    <style>
      html {
        overflow-y: scroll;
      }
      body, html {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #placeholder {
        width: 100%;
        min-height: 90%;
      }
      #tooltip {
          font-size: 11px;
          font-family: sans-serif;
          position: absolute;
          display: none;
          border: 1px solid #ddf;
          padding 2px;
          opacity: 0.8;
          background-color: #eef;
          padding: 5px;
      }
      #tooltip #text {
        float:right;
        padding: 4px;
      }
      #artist {
        font-weight: bold;
      }
      #date {
        font-weight: bold;
      }
      #tooltip img {
        float:left;
      }
    </style>
  </head>
  <body>
    <form>
      <input id="search" name="search"></input>
      <input type="submit" value="Search">
    </form>
    <div id="placeholder" style="width:100%;height:95%"></div>
  </body>
  <script src="flot/jquery.js"></script>
  <script src="flot/jquery.flot.js"></script>
  <script src="flot/jquery.flot.navigate.js"></script>
  <script src="flot/jquery.flot.resize.js"></script>
  <script src="date.js"></script>
  <script src="underscore.js"></script>
  <script>

    // distinct colors that aren't likely to be confused with one another
    var colors = [ "red", "green", "blue", "purple", "yellow", "orange", "cyan", "magenta" ];

    var dataInGraph = false;
    function resetAndRedrawScrobbles(scrobbles) {
      dataInGraph = true;

    }

    $.getJSON("all_scrobbles.Mark_Hansen.json", function (scrobbles) {
      function compute_top_artists(scrobbles) {
        var artist_scrobbles_hash = {};
        for (var i = 0; i < scrobbles.length; i++) {
          var scrobble = scrobbles[i];
          var artist = scrobble.artist["#text"];
          if (artist_scrobbles_hash[artist]) {
            artist_scrobbles_hash[artist].push(scrobble);
          } else {
            artist_scrobbles_hash[artist] = [ scrobble ];
          }
        }

        var artist_scrobbles_array = [];

        for (var artist in artist_scrobbles_hash) {
          if (artist_scrobbles_hash.hasOwnProperty(artist)) {
            artist_scrobbles_array.push(artist_scrobbles_hash[artist]);
          }
        }

        artist_scrobbles_array.sort(function(a,b) { return b.length - a.length; });
        var top_artists = []
        for (var i = 0; i < artist_scrobbles_array.length; i++) {
          top_artists.push(artist_scrobbles_array[i][0]["artist"]["#text"]);
        }
        return top_artists;
      }
      var artists = compute_top_artists(scrobbles);

      artist_colors = {};
      for (var i = 0; i < artists.length; i++) {
        var artist = artists[i];
        var color = colors[i] || "gray";
        artist_colors[artist] = color;
      }

      var minTime = Number.POSITIVE_INFINITY;
      var maxTime = Number.NEGATIVE_INFINITY;
      for (var i = 0; i < scrobbles.length; i++) {
        var scrobble = scrobbles[i];
        var date = new Date(scrobble.date.uts * 1000);
        if (date.getTime() < minTime) minTime = date.getTime();
        if (date.getTime() > maxTime) maxTime = date.getTime();
      }

      function scrobbles_to_series(scrobbles) {
        return _(scrobbles).map(function (scrobble) {
          var date = new Date(scrobble.date.uts * 1000);
          var time = date.getHours() + (date.getMinutes() / 60);
          var artist = scrobble.artist["#text"];
          return {
            color: artist_colors[artist],
            data: [[date.getTime(), time]],
            scrobble: scrobble
          }
        });
      }

      var plot = $.plot($("#placeholder"), scrobbles_to_series(scrobbles), { 
        xaxis: {
          mode: "time", 
          timeformat: "%d %b %y",
          tickLength: 0,
          zoomRange: [1000*60*60*24, maxTime - minTime],
          panRange: [minTime, maxTime]
        },
        yaxis: {
          transform: function (v) { return -v; }, // invert
          inverseTransform: function (v) { return -v; },
          min: 0,
          max: 24,
          tickLength: 0,
          ticks: [0, 3, 6, 9, 12, 15, 18, 21, 24 ],
          tickFormatter: function(val, axis) {
            if (val == 0) return "12am"
            if (val < 12) return val + "am";
            if (val == 12) return "12pm";
            return (val - 12) + "pm";
          },
          zoomRange: false,
          panRange: false
        },
        points: { 
          radius: 0.5,
          show: "true"
        },
        grid: {
          hoverable: true
        },
        zoom: {
          interactive: true
        },
        pan: {
          interactive: true
        }
      });
      $("form").submit(function (e) {
        plot.setData([])
        plot.draw();
        var re = new RegExp($("#search").val(), "i");
        var filtered_scrobbles = [];
        for (var i = 0; i < scrobbles.length; i++) {
          var scrobble = scrobbles[i];
          var track = scrobble.name;
          var artist = scrobble.artist["#text"];
          var album = scrobble.album["#text"];
          if (re.exec(track) || re.exec(artist) || re.exec(album)) {
            filtered_scrobbles.push(scrobble);
          }
        }
        plot.setData(scrobbles_to_series(filtered_scrobbles));
        plot.draw();
        e.preventDefault();
      });

      var previousPoint = null;
      $("#placeholder").bind("plothover", function (event, pos, item) {
        if (!item) {
          return;
        }
        if (previousPoint == item.seriesIndex) {
          return;
        }
        previousPoint = item.seriesIndex;
        $("#tooltip").remove();
        showTooltip(item.pageX, item.pageY, item.series.scrobble);
      });
      function showTooltip(x, y, scrobble) {

        var tipWidth = 300;
        var tipHeight = 66;
        var xOffset = 5;
        var yOffset = 5;
        var scrollLeft = window.pageXOffset;
        var scrollTop = window.pageYOffset;
        var docWidth = window.innerWidth - 15;
        var docHeight = window.innerHeight - 8;

        if (y + tipHeight - scrollTop > docHeight) { // off the bottom side
          var calculatedY = y - tipHeight - yOffset;
        } else { 
          var calculatedY = y;
        }

        if (x + tipWidth - scrollLeft > docWidth) { // over the right side
          var css = { 
            top: calculatedY,
            right: docWidth - x + xOffset 
          };
        } else {
          var css = { 
            top: calculatedY,
            left: x + xOffset 
          };
        }
        $("<div id='tooltip'>").
          append($("<div id='text'>").
            append($("<div id='name'>").text(scrobble.name)).
            append($("<div id='artist'>").text(scrobble.artist["#text"])).
            append($("<div id='album'>").text(scrobble.album["#text"])).
            append($("<div id='date'>").text(new Date(scrobble.date.uts * 1000)).toString("HH:mm, ddd dd MMM yyyy"))
          ).css(css).appendTo("body").fadeIn(200);

        if (scrobble.image[0] && scrobble.image[0]["#text"]) {
          var img = new Image();
          img.src = scrobble.image[1]["#text"];
          $(img).prependTo("#tooltip");
        }
      }
    });
  </script>
</html>
